<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>람쥐 서버 · 힐링 야생 RPG · 사전예약</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&family=Marcellus&display=swap" rel="stylesheet">
  <!-- Fallback inline style to avoid white screen if CSS fails -->
  <style>body{background:#2b1e12;color:#faefe3}</style>
  <link rel="stylesheet" href="/style.css?v=3">
  <meta name="theme-color" content="#3b2a1b">
</head>
<body>
  <div class="bg">
    <div class="texture"></div>
    <div class="vignette"></div>
  </div>

  <header class="header wrap">
    <div class="brand">
      <img class="logo-img" src="/assets/ramjwi_logo.png" alt="람쥐 서버 로고" onerror="this.style.display='none'"/>
      <div class="brand-text">
        <div class="logo">람쥐 서버</div>
        <div class="subtitle">힐링 야생 RPG · 사전예약</div>
      </div>
    </div>
    <div id="authArea" class="auth"></div>
  </header>

  <main class="wrap fade-in">
    <section class="hero card glass raise">
      <div class="hero-left">
        <h1>포근한 힐링과 모험이 공존하는 야생 RPG</h1>
        <p class="muted">디스코드에서 “사전 예약하기” 버튼으로 참여한 뒤, 아래에서 내 상태를 확인하세요.</p>
        <div class="badges">
          <span class="badge">야생</span>
          <span class="badge">RPG</span>
          <span class="badge">힐링</span>
          <span class="badge">멀티플레이</span>
        </div>
        <a class="btn invite pulse" href="https://discord.gg/FVXQN8ry" target="_blank" rel="noopener">디스코드 초대 참여</a>
      </div>

      <div class="check">
        <div class="row">
          <input id="mcName" placeholder="마크 닉네임 (3~16자)" maxlength="16"/>
          <button class="btn ghost" id="btnCheck">닉네임 확인</button>
        </div>
        <div id="checkResult" class="muted small"></div>
      </div>
    </section>

    <section class="grid">
      <div class="card glass raise">
        <h3>내 예약 상태</h3>
        <div id="meBox" class="mebox muted">로그인하면 예약 상태를 표시합니다.</div>
        <div class="hint small muted">※ 사전예약은 디스코드 서버 내 <b>/사전예약패널</b> → <b>사전 예약하기</b> 버튼으로 진행됩니다.</div>
      </div>

      <div class="card glass raise">
        <div class="list-head">
          <h3>사전예약 명단</h3>
          <div class="list-head-tools row">
            <label class="muted small">정렬</label>
            <select id="sortBy">
              <option value="latest">최신 등록순</option>
              <option value="oldest">오래된 등록순</option>
              <option value="nick">닉네임 A→Z</option>
              <option value="mc">마크닉 A→Z</option>
            </select>
            <label class="muted small">페이지</label>
            <select id="pageSize">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
            </select>
            <input id="searchInput" class="search" placeholder="닉네임 검색">
          </div>
        </div>
        <ul id="list" class="list"><li class="muted">불러오는 중...</li></ul>
        <div class="pager row">
          <button class="btn ghost" id="prevBtn">이전</button>
          <span id="pageInfo" class="muted small">1 / 1</span>
          <button class="btn ghost" id="nextBtn">다음</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="wrap footer">
    <div>© <span id="year"></span> 람쥐 서버 · Healing Survival RPG</div>
    <div class="muted small">Discord 로그인 시 아바타/닉네임 및 예약 상태가 표시됩니다.</div>
  </footer>

  <script>
    const api = {
      list: "/api/list",
      me: "/api/me",
      validate: (name) => `/api/validate-name?name=${encodeURIComponent(name)}`,
      login: "/auth/login",
      logout: "/auth/logout",
    };

    const el = (q) => document.querySelector(q);

    async function fetchJSON(url){
      const r = await fetch(url, {credentials: "include"});
      if(!r.ok) throw new Error("fetch failed");
      return await r.json();
    }

    function fmtTime(iso){
      try{
        const d = new Date(iso);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${dd} ${hh}:${mm}`;
      }catch(e){ return iso; }
    }

    // ---- Auth + Me ----
    async function loadAuth(){
      try{
        const me = await fetchJSON(api.me);
        const area = el("#authArea");
        if(me.loggedIn){
          const p = me.profile;
          area.innerHTML = `
            <img class="avatar" src="${p.avatar_url}" alt="avatar"/>
            <div class="who">
              <div class="name">${p.global_name || p.username}</div>
              <a class="link small muted" href="${api.logout}">로그아웃</a>
            </div>
          `;
          const box = el("#meBox");
          if(me.reserved){
            const r = me.reservation;
            box.innerHTML = `
              <div class="me">
                <div class="state ok">✅ 사전예약 완료</div>
                <div class="rows">
                  <div><span class="label">디스코드</span><span>${p.global_name || p.username}</span></div>
                  <div><span class="label">마크 닉네임</span><span><b>${r.mc_name}</b></span></div>
                  <div><span class="label">등록 시각</span><span>${fmtTime(r.created_at)}</span></div>
                </div>
              </div>`;
          }else{
            box.innerHTML = `
              <div class="me">
                <div class="state warn">⏳ 아직 사전예약 전</div>
                <div class="rows">
                  <div><span class="label">안내</span><span>디스코드에서 <b>/사전예약패널</b> → <b>사전 예약하기</b> 버튼으로 신청하세요.</span></div>
                </div>
              </div>`;
          }
        }else{
          area.innerHTML = `<a class="btn" href="${api.login}">Discord로 로그인</a>`;
          el("#meBox").innerHTML = `로그인하면 내 예약 상태를 확인할 수 있습니다.`;
        }
      }catch(e){
        el("#authArea").innerHTML = `<span class="muted small">인증 정보를 불러올 수 없습니다.</span>`;
      }
    }

    // ---- List with sort/filter/pagination ----
    let rawList = [];
    let filtered = [];
    let current = 1;
    let pageSize = 20;
    const sortSel = el("#sortBy");
    const sizeSel = el("#pageSize");
    const pageInfo = el("#pageInfo");

    function sortData(arr){
      const v = sortSel.value;
      const a = [...arr];
      if(v === "latest"){
        a.sort((x,y)=> new Date(y.created_at) - new Date(x.created_at));
      }else if(v === "oldest"){
        a.sort((x,y)=> new Date(x.created_at) - new Date(y.created_at));
      }else if(v === "nick"){
        a.sort((x,y)=> (x.nickname||"").localeCompare(y.nickname||""));
      }else if(v === "mc"){
        a.sort((x,y)=> (x.mc_name||"").localeCompare(y.mc_name||""));
      }
      return a;
    }

    function renderPage(){
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if(current > pages) current = pages;
      const start = (current-1)*pageSize;
      const pageItems = filtered.slice(start, start+pageSize);

      const ul = el("#list");
      if(!pageItems.length){
        ul.innerHTML = `<li class="muted">명단이 비었거나 조건에 맞는 결과가 없습니다.</li>`;
      }else{
        ul.innerHTML = pageItems.map(x => `
          <li class="li">
            <div class="nick">${x.nickname}</div>
            <div class="sub muted">(MC: ${x.mc_name})</div>
            <div class="time badge">${fmtTime(x.created_at)}</div>
          </li>
        `).join("");
      }
      pageInfo.textContent = `${current} / ${pages}`;
    }

    function applyFilter(){
      const q = (el("#searchInput").value||"").trim().toLowerCase();
      const sorted = sortData(rawList);
      if(!q){
        filtered = sorted;
      }else{
        filtered = sorted.filter(x =>
          (x.nickname||"").toLowerCase().includes(q) ||
          (x.mc_name||"").toLowerCase().includes(q)
        );
      }
      current = 1;
      renderPage();
    }

    async function loadList(){
      try{
        rawList = await fetchJSON(api.list);
        applyFilter();
      }catch(e){
        el("#list").innerHTML = `<li class="muted">불러오기 실패</li>`;
      }
    }

    // Events
    el("#searchInput").addEventListener("input", applyFilter);
    sortSel.addEventListener("change", applyFilter);
    sizeSel.addEventListener("change", ()=>{
      pageSize = parseInt(sizeSel.value,10) || 20;
      current = 1; renderPage();
    });
    el("#prevBtn").addEventListener("click", ()=>{ if(current>1){ current--; renderPage(); } });
    el("#nextBtn").addEventListener("click", ()=>{ current++; renderPage(); });

    // Check name
    el("#btnCheck").onclick = async () => {
      const name = el("#mcName").value.trim();
      if(!name){ alert("닉네임을 입력하세요."); return; }
      const btn = el("#btnCheck"); btn.disabled = true;
      try{
        const r = await fetchJSON(api.validate(name));
        el("#checkResult").textContent = r.ok ? `✅ 실존 계정: ${r.name}` : "❌ 존재하지 않는 닉네임";
        el("#checkResult").className = r.ok ? "ok small" : "err small";
      }catch(e){
        el("#checkResult").textContent = "⚠️ 확인 실패";
        el("#checkResult").className = "warn small";
      }finally{
        btn.disabled = false;
      }
    };

    document.getElementById("year").textContent = (new Date()).getFullYear();
    loadAuth();
    loadList();
  </script>
</body>
</html>
